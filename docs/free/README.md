# free

```shell
$ free -m # MB
```

![](/docs/free/images/free.png)

## buff/cache

- buff는 블록 디바이스가 가지고 있는 블록 자체에 대한 캐시
- cache는 I/O 성능 향상을 위해 사용하는 페이지 캐시

### cache

페이지 캐시는 메모리 영역의 cache에 해당한다. 쉽게 말해 특정 애플리케이션이 블록 디바이스(디스크 드라이브)로부터 파일을 직접적으로 접근하여 가져오는 것이 아닌, 커널의 페이지 캐시 기능을 바라보고 캐시된 파일을 가져오는 기능이다.

직접 접근하여 가져오는 경우에는 디스크 드라이브에 접근하여 가져오기 때문에 메모리에 있는 내용을 가져오는 것에 비해 당연히 느릴 수 밖에 없다.

즉, 페이지 캐시는 한 번 읽었던 파일을 페이지 캐시에 저장함으로써 블록 디바이스가 아닌 메모리에서 파일의 내용을 가져와 I/O 성능을 향상시켜준다.

## free vs available

- free는 어느 누구도 사용하고 있지 않은 메모리
- available은 애플리케이션에게 실질적으로 할당 가능한 메모리

buff/cache는 위에서 말했듯, I/O 성능 향상을 위해 존재한다. 따라서 애플리케이션에서 메모리가 필요할 경우, buff/cache 영역을 해제하고 애플리케이션이 사용할 수 있는 영역으로 바꿔준다.

이 말은 즉슨, 애플리케이션에서 OOME가 발생한다면, 메모리 확보를 위해 프로세스를 죽이는 것보다 I/O 성능이 떨어지더라도 buff/cache 영역을 해제하여 메모리를 필요한 곳에 할당해주는 것이 맞다는 의미다.

따라서 `available = free + buff/cache`를 의미한다. 만약 buff/cache가 높다면 I/O가 많이 일어나는 환경이기에 오히려 더 많은 메모리를 할당해주는 것이 맞다.

## swap

swap은 메모리가 부족한 상황에서 사용되는 가상 메모리 공간을 의미한다. 메모리가 아니며 주로 블록 디바이스의 일부 영역을 사용한다.

예를 들어 메모리가 가득차있는 상태에서 커널에 메모리를 추가적으로 요청할 경우를 생각해보자.

커널은 특정 메모리를 swap에 저장시켜 메모리를 확보한다. (`swap out`)

만약 특정 프로세스가 swap out된 메모리를 찾을 경우에는, 또 다시 특정 메모리를 swap out하여 메모리 공간을 확보하고, 필요한 메모리를 swap에서 메모리 영역으로 가져온다. (`swap in`)

추가적으로 swap in된 메모리는 swap 영역에서 지워지지 않는다. (`swap cached`)

결국 swap out, swap in이라는 행위는 I/O가 일어나기 때문에 성능 저하가 발생한다. 즉, swap 영역이 사용된다면 성능 저하의 문제가 발생한다는 의미다.

## 고려사항

순서를 생각해보면, OOME가 발생했을 때 다음과 같이 문제를 해결하게 된다.

```
1. buff/cache
2. swap
3. oom killer
```

여기서 생각해야할 점은 swap을 이용함으로서 성능이 떨어지더라도 OOM Killer에 의해 죽는 것을 막을 것인지 혹은 swap을 이용하지 않고 성능이 떨어질 바에 OOM Killer에 의해 죽는게 나을 지를 고민해봐야한다.

최근 트렌드는 swap 영역을 비활성화하는 추세다. 대부분 K8S와 같은 컨테이너 환경을 많이 사용하면서, 빠르게 다시 애플리케이션/프로세스를 띄울 수 있다는 장점으로 인해 굳이 swap의 역할을 수행할 필요가 없다 판단했기 때문이다. 그래도 프로세스가 죽음으로서 발생하는 크리티컬한 문제가 있을 경우에는(ex. DB) swap 영역을 할당하여 안정성을 확보하는 것이 좋다.

## 정리

- free 명령어를 이용하여 시스템의 메모리 사용 현황을 확인할 수 있다.
- available은 실질적으로 프로세스에게 할당할 수 있는 메모리양을 의미한다.
- 만약 buff/cache가 높다면 I/O가 빈번하게 발생한다는 의미다.
- swap 영역을 사용한다는 것은 메모리가 부족하다는 신호다.
